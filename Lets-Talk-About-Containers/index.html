<!doctype html>
<html lang="de">
  <head>
	<meta charset="utf-8">
	<title>FIXME(cglaubitz): INSERT TITLE HERE</title>
	<meta name="description" content="Containers then and now">
	<meta name="author" content="Christoph Glaubitz">
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
	<link rel="stylesheet" href="../reveal.js-3.0.0/css/reveal.css">
	<link rel="stylesheet" href="../reveal.js-3.0.0/css/theme/syseleven.css" id="theme">
	<link rel="stylesheet" href="../reveal.js-3.0.0/lib/css/zenburn.css">
	<link rel="stylesheet" href="../font-awesome-4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="css/chris.css">
	<script>
		var link = document.createElement( 'link' );
		link.rel = 'stylesheet';
		link.type = 'text/css';
		link.href = window.location.search.match( ../reveal.js-3.0.0/print-pdf/gi ) ? '../reveal.js-3.0.0/css/print/pdf.css' : '../reveal.js-3.0.0/css/print/paper.css';
		document.getElementsByTagName( 'head' )[0].appendChild( link );
	</script>
	<!--[if lt IE 9]>
	<script src="lib/js/html5shiv.js"></script>
	<![endif]-->
  </head>
  <body>
    <div class="reveal">
      <div class="slides">

<section data-markdown data-separator="^\n---\n$" data-separator-vertical="^\n--\n$">
<pre><code></code></pre>
<script type="text/template" >
<!-- .slide: class="left" data-background="../reveal.js-3.0.0/sys11-images/140212-SYS11-Presentor-Background-01-Title-02-90.png" -->

Containers then and now<!-- .element: style="font-size:150%;" -->

<aside class="author">
Christoph Glaubitz<br>
Cloud Architect at SysEleven GmbH<br>
<span class="location">ContainerDays Hamburg, 27 &amp; 28.06.2016</span>
</aside>

---

#### What could you expect from this talk?

* Brief introduction about our infrastructure
* Different ways of deploying software
* You need more than just a container

---

### What are you guys at SysEleven doing?

---

### Running two types of infrastructure!

---

### A new one, based on OpenStack…

![OpenStack](img/Cloud_OpenCloud_Chillin.png)

---

### … an old one, based on Parallels Virtuozzo…

![Virtuozzo](img/virtuozzo.jpg)

Note:

Which basically provides integration into OpenStack these days

---

… but most important: Provide, maintain and monitor the infrastructure into which our customers can deploy their code into.

![Managed](img/managed.png)

Note:

* monitoring as in: doing 24x7 for our customers

---

### Let's step into the virtuozzo platform

---

In the past, Virtuozzo was basically

* image format
* local storage
* Linux based container runtime
 * (but maintained outside of mainline)

Note:

around 2008

Which is still true, but there is more

---

But treating containers like usual virtual machines

* with a complete Linux running inside
* sure, except of the kernel
* injecting files to distribution dependend locations

Note:

Your targeted distribution has to be supported

But with a huge performance benefit over VMs

---

### Some more history

![History](img/history.png)

---

From the early days, we have decent trending and alerting for all the services the customer provides.

Note:

nagios + zabbix for monitoring

---

We even built a web frontend, which gathered data from multiple nagios instances to give us a single overview.

![sNagios](img/nagios.png)

Note:

We run to many things to monitor for a single instance, running on a 24 Core XEON with 94GB RAM

---

Over time, we built billing, a local DNS-API, SSL-Cert "shop", some own metering-endpoints, Backups…

---

…we even developed some tools, to spawn new containers with a minimum set of needed configuration.

![Robot](img/robot.jpg)

---

But we still totally lack a customer facing API.

![Public](img/public.jpg)

Note:

* Because of this we decided use OpenStack

---

### At some point, Configuration Management became cool

![Puppet](img/puppet.png)

Note:

… and we added a Puppet Master to our infrastructure, and registered all the containers to it. Based on this, we automated much stuff, like provisioning of basic stuff to the container and registering services to the monitoring.


---

### These days we are running

![listvps](img/listvps.png)

Note:

about 3000 of those containers

on about 300 physical machines

---

# But

---

We still treat the containers like computers.

Note:

* more litally

---

![Giraf](img/giraf.jpg)

Note:

* like cute baby girafs

---

### A traditional setup is still

* MySQL master slave setup
* Admin server
* a bunch of App server
* maybe some kind of search engine

---

We start the containers, using out internal toolchain.

---

This also triggers puppet to install required software in the container, setting up configuration and register them to our monitoring.

---

We hand over *exactly* this fully managed container to the customer.

![Fully managed container](img/managed-container.jpg)
https://www.flickr.com/photos/lindzgraham/<!-- .element: style="font-size: 50%" -->

Note:

Not any kind of image

---

Customers deploy their software to the admin server. From there it will be rsynced to the app server.

![Deploy](img/deploy.jpg)
https://www.flickr.com/photos/auxesis/<!-- .element: style="font-size: 50%" -->

---

This sucks in some ways!

---

Installation of the containers/computer *only* works in our infrastructure.

---

So changes to the infra hurt.

---

We have startup dependencies rather than build dependencies.

Note:

Many of them

---

Since the containers are used like computers, there is data in it. So it's not very reproducable.

Note:

At least the entire deployment is not very repeatable.

---

Often a new container is just a clone of an old one!

Note:

With things like host name and monitoring stuff changed

---

So we keep the containers alive, no matter what happens. In the worst case, we clone one back from the nightly backup.

Note:

Like you might expect. We have to backup the entire container.

---

Don't get me wrong!

---

You can build shiny new container images with the same problems!

---

Updates have to go to all containers…

![Updates](img/updates.jpg)

https://www.flickr.com/photos/bovinity/<!-- .element: style="font-size: 50%" -->

---

… rather than building a new image and replace old containers.

![Replace Container](img/old-container.jpg)

https://www.flickr.com/photos/nicowa/<!-- .element: style="font-size: 50%" -->

Note:

Again, with only build dependencies

---

FIXME move somewhere else
Because of this, we also faced problems with updating the underlying Virtuozzo infrastructure.

Note:

Some updates need changes to the running Filesystem, that are incompatible to earlier versions

So we are not able to move containers back to a host with an older version

---

Customers software is not packaged in any way.

Note:

It is not easy to verify the installation

---

You don't have an overview of the versions of the deployed software.

---

Rollbacks to a defined set of installed software and deployed software are nearly impossible.

![Rollback](img/rollback.jpg)

https://www.flickr.com/photos/thejesse/<!-- .element: style="font-size: 50%" -->

Note:

For sure, everything is possible. Some thing just cause more pain.

Just to name a few

---

What about

![Docker](img/dacker.jpg)

?

---

![Sys11Stack](img/sys11stack.png)

---

### What do we get from the shiny new world of containers?

---

First of all: Another layer of indirection!

---

Did I mention, that you should keep your infrastructure as boring as possible?

---

Interresting infrastructure tends to fail in interresting ways!

Note:

Anyway. Lets get back to the containers.

---

Thanks to Docker, it is very very easy to build images! 

---

Unfortunately it is also very easy to build crappy images!!

---

* Never ever build software in a container that should go to production and leave traces of build utils!
 * Build in a prepared build-container, that only exists to create the artefact.
* You may should build packages for your targeted distribution.
 * Especially if you have dependencies to dist stuff.
* Use Best practices, the tool does not force you to do it right.

Note:

Read on image best practices and why deleting stuff does not reduce the image size!

---

* Never add platform specific stuff like monitoring agents into your container.
* Endpoints for specific monitoring systems are recommended…
* But other services, and a monitoring agent is one, should go into a sidekick container!

---

At this point, you only have build dependencies!

No apt-get/git clone when spawning the container.

Note:

But this is totally up to you.

---

### The real fun starts when your image is created and lives in some registry!

Note:

* No matter if public or private

---

There are ways, like docker-compose or kubectl, to define and run a deployment.

Note:

* So you can test your deployment over and over agan.
* In case of docker-compose they can be set up even locally!
 * or against docker-swarm

---

Really. I dreamed of such things at some points in my IT-life.

---

In the past, I had to deal with deployments to specific hosts, rather than spawning new containers to replace old ones.

Note:

Again. Remember the cute giraf.

---

In any way: Your infrastructure is code as well.

Note:

Which is really good!

---

It is easy to build fresh setups for testing and Q&amp;A.

---

Later, the accepted deployment will be shipped to production.

---

FIXME throw away? But lets step back from full blown container orchestrations.

---

FIXME throw away? Even if you don't want to use that complicated and addition layers, you gained a huge benefit!

---

You can run your image everywhere!

Note:

* No matter what: Baremetal, AWS, OpenStack, Google Cloud Engine, you name it.
* Except of our legacy platform tue to technical restrictions.
* In new versions of Virtuozzo this would work fine too.

---

And this is IMHO the most important of the container movement.

---

These days you can also run your Linux container image

* in a chroot without cgroups/namespaces using rkt fly by CoreOS
* in a small KVM (with an injected kernel), thanks to CoreOS and Intel

---

You can run it on FreeBSD using JetPack

---

You can even run on Windows!

---

And all this *without* any modification to your image!

---

### But there will be dragons!

---

In my experience, deployments fail more likely because of misconfigured next-hops (like DB), instead of crappy software.

Note:

* Anyway. You now can test it over and over again.

---

Plugging services together is even more difficult in a floating environment.

Note:

* Things like Service Discovery are far out of scope here.

---

You decouple yourself from the exact host, the container is running on.

---

Which definitely does not mean, that you are free of any operational issues.

---

The opposite is true!

---

You have new things running in your infrastructure.

---

Like a new orchestration layer.

---

Or a distributed key/value-Store.

---

Some kind of Service Discovery.

---

You need someone to operate all the new stuff!

---

Debugging apps in containers becomes different.

---

You don't have to throw away your debugging skills!

---

Again the opposite! You have to extend these skills by container debugging!

---

FIXME
For me, that sounds like creating more operational burdon, instead of reducing.

---

### Your applications have to be changed!

---

They have to be "Cloud Ready".

Note:

Bingo

---

Little startup times.

Note:

Otherwise the benefit of not spawning an entire VM does not count.

---

Should be "stateless".

Note:

"global" session stores

There is no lb stickiness!

---

### But

---

You will always have stateful systems.

---

Deal with it.

---

Think about twice or three times.

---

This is the compliacted stuff to deploy!

---

Monitor those services very well!

---

Plan, test and **regulary trigger** failover mechanisms.

---

I strongly encourage you to read on this.

* https://charity.wtf/2016/05/31/wtf-is-operations-serverless/<!-- .element: style="font-size: 50%" -->
* https://charity.wtf/2016/05/31/operational-best-practices-serverless/<!-- .element: style="font-size: 50%" -->

---

### Back SysEleven: Where could we use containers?

Note:

* reminding how we manage services so far.

---

A layer on top of OpenStack Compute Nodes

* kubernetes
* docker-swarm
* CoreOS fleet
* Orchestration e.g. via ansible

Note:

Yes. There are solutions from OpenStack. But they in fact do the same.

 * But may lock you into the OpenStack Container API

This is the only way to isolate customers from each other.

 * Most open source container orchestration solutions are not yet ready for multi tenancy

---

Customers could use base images from some official registry and build their own images.

Note:

* Like Docker Hub or quay by CoreOS

---

We could as well provide some base images that we maintain.

---

### But: Here will be some more Dragons

---

We have to maintain the additional layer!

One for each customer!

---

Do we monitor the services of the customer and be alarmed when they go down?

---

Or, do we just monitor the orchestration-layer?

---

What if there is a critical bug in some image?

---

Who is responsible to build a new "production" image?

---

Do we have access to customers code/artefacts to build a new image?

---

Or, do we just notify customers?

---

Who is responsible for rolling out the new image?

Note:

* To recap
* Currently we only update/maintain dist software.
* Do not touch the customers software.

---

All this, and more that I forgot here, may differ from one customer to the other.

---

### Sounds like even more work for our Admins! Are there any benefits?

---

A very streamlined deployment process!

Note:

No difference between self-deployer

and customers, who only handover their code.

---

In case of Kubernetes: Using Replication Controller.

Note:

Maybe even with auto scaling

Where auto scaling is limited to the running VMs in the kubernetes cluster.

---

Kubernetes takes care about the number of running Pods.

---

No alerts because of a failing frontend node!

---

We are able to run more than one service on a VM. No matter what kind of linux each single service needs.

---

### Is "onto of OpenStack" the only possible area to use containers at SysEleven?

---

Far away from what is possible!

---

For example, also OpenStack Services are…

---

… Services!

---

Why not maintaining a kubernetes cluster and run OpenStack as a Service?

---

Seriously!

![Stackanetes](img/tectonic-k8s-openstack.svg)

https://tectonic.com/blog/openstack-and-kubernetes-come-together.html

---

### These technologies are around there!

---

They will gain you benefits.

---

But they will introduce new layers of indirection, that you have to manage.

Note:

* or someone for you

---

Not everything fits into a container.

![float problem](img/float_problem.gif)

Note:

* No one forces you to use containers!

---

Nothing will solve all your problems

![Problems](img/all_problems.jpg)

---

# Check the ecosystem

* http://chrigl.de/slides/sysconf15-docker/#/ecosystem<!-- .element: style="font-size: 50%" -->
* http://chrigl.de/slides/sysconf15-docker/#/resources<!-- .element: style="font-size: 50%" -->

Note:

shameless self plugging

---

# And use it!

---

###  But use it wisely!

![Container fail](img/container-accident.jpg)

---

<!-- .slide: class="left" -->

## Thanks! Questions?<!-- .element: style="margin-left:-40px;" -->


![Christoph Glaubitz](../img/Chris.jpg)<!-- .element: style="float:left; margin-left:-40px; margin-right:30px !important;" -->

Contact me:<br>
<i class="fa fa-envelope"></i> [c.glaubitz@syseleven.de](mailto:c.glaubitz@syseleven.de)

Get Awesome Hosting:<br>
[SysEleven.de](http://www.syseleven.de)

Slides & Contribute:<br>
[ThomasLohner.github.io](https://ThomasLohner.github.io/slides/)


</script>
</section>

      </div>
    </div>
	<script src="../reveal.js-3.0.0/lib/js/head.min.js"></script>
	<script src="../reveal.js-3.0.0/js/reveal.js"></script>
	<script>
		// Full list of configuration options available at:
		// https://github.com/hakimel/reveal.js#configuration
		Reveal.initialize({
			controls: true,
			progress: true,
			history: true,
			center: true,
			slideNumber: false,
			hideAddressBar: true,
			transition: 'slide', // none/fade/slide/convex/concave/zoom
			// Optional reveal.js plugins
			dependencies: [
				{ src: '../reveal.js-3.0.0/lib/js/classList.js', condition: function() { return !document.body.classList; } },
				{ src: '../reveal.js-3.0.0/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
				{ src: '../reveal.js-3.0.0/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
				{ src: '../reveal.js-3.0.0/plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
				{ src: '../reveal.js-3.0.0/plugin/zoom-js/zoom.js', async: true },
				{ src: '../reveal.js-3.0.0/plugin/notes/notes.js', async: true }
			]
		});
    </script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-3595616-6', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
